import{visit as e,Kind as t,print as n}from"graphql";import{k as r,s as o,C as s,m as c,a as u,b as l,c as y,d,e as p,g as k,f as x}from"./4d037e29.min.mjs";export{C as CombinedError,f as createRequest,j as getOperationName,a as makeErrorResult,m as makeResult,i as mergeResultPatch,h as stringifyVariables}from"./4d037e29.min.mjs";import{subscribe as w,share as b,map as q,filter as g,tap as O,merge as _,mergeMap as v,takeUntil as S,make as E,onPush as P,makeSubject as N,onEnd as R,onStart as M,publish as D,take as A,switchMap as Q,fromValue as F}from"wonka";const I=(e,t)=>{if(Array.isArray(e))for(const n of e)I(n,t);else if("object"==typeof e&&null!==e)for(const n in e)"__typename"===n&&"string"==typeof e[n]?t.add(e[n]):I(e[n],t);return t},L=e=>{if(!e.selectionSet)return e;for(const n of e.selectionSet.selections)if(n.kind===t.FIELD&&"__typename"===n.name.value&&!n.alias)return e;return{...e,selectionSet:{...e.selectionSet,selections:[...e.selectionSet.selections,{kind:t.FIELD,name:{kind:t.NAME,value:"__typename"}}]}}},T=new Map,J=t=>{const n=r(t);let o=T.get(n.__key);return o||(o=e(n,{Field:L,InlineFragment:L}),Object.defineProperty(o,"__key",{value:n.__key,enumerable:!1}),T.set(n.__key,o)),o},G=e=>{if(e&&"object"==typeof e){if(Array.isArray(e))return e.map(G);if(e&&"object"==typeof e&&"__typename"in e){const t={};for(const n in e)"__typename"===n?Object.defineProperty(t,"__typename",{enumerable:!1,value:e.__typename}):t[n]=G(e[n]);return t}return e}return e};function U(e){return e.toPromise=()=>new Promise((t=>{const n=w((e=>{e.stale||e.hasNext||Promise.resolve().then((()=>{n.unsubscribe(),t(e)}))}))(e)})),e}function V(e,t,n){return n||(n=t.context),{key:t.key,query:t.query,variables:t.variables,kind:e,context:n}}const W=(e,t)=>V(e.kind,e,{...e.context,meta:{...e.context.meta,...t}}),$=()=>{},z=(e,n,r)=>{for(const s of r)if(s.kind===t.FRAGMENT_DEFINITION){const t=s.name.value,r=o(s);e.has(t)||(e.set(t,r),n.push(s))}else n.push(s)};function B(){const e=new Map,n=[],o=[];let s=Array.isArray(arguments[0])?arguments[0][0]:arguments[0]||"";for(let e=1;e<arguments.length;e++){const t=arguments[e];t&&t.definitions?o.push(...t.definitions):s+=t,s+=arguments[0][e]}return z(e,n,r(s).definitions),z(e,n,o),r({kind:t.DOCUMENT,definitions:n})}const H=({kind:e})=>"mutation"!==e&&"query"!==e,K=({forward:e,client:t})=>{const n=new Map,r=new Map,o=e=>{const t=V(e.kind,e);return t.query=J(e.query),t},s=e=>{const{key:t,kind:r,context:{requestPolicy:o}}=e;return"query"===r&&"network-only"!==o&&("cache-only"===o||n.has(t))};return i=>{const a=b(i),c=q((e=>{const r=n.get(e.key),o={...r,operation:W(e,{cacheOutcome:r?"hit":"miss"})};return"cache-and-network"===e.context.requestPolicy&&(o.stale=!0,X(t,e)),o}))(g((e=>!H(e)&&s(e)))(a)),u=O((e=>{let{operation:o}=e;if(!o)return;const s=(e=>[...I(e,new Set)])(e.data).concat(o.context.additionalTypenames||[]);if("mutation"===e.operation.kind){const e=new Set;for(let t=0;t<s.length;t++){const n=s[t];let o=r.get(n);o||r.set(n,o=new Set);for(const t of o.values())e.add(t);o.clear()}for(const r of e.values())n.has(r)&&(o=n.get(r).operation,n.delete(r),X(t,o))}else if("query"===o.kind&&e.data){n.set(o.key,e);for(let e=0;e<s.length;e++){const t=s[e];let n=r.get(t);n||r.set(t,n=new Set),n.add(o.key)}}}))(e(g((e=>"query"!==e.kind||"cache-only"!==e.context.requestPolicy))(q((e=>W(e,{cacheOutcome:"miss"})))(_([q(o)(g((e=>!H(e)&&!s(e)))(a)),g((e=>H(e)))(a)])))));return _([c,u])}},X=(e,t)=>e.reexecuteOperation(V(t.kind,t,{...t.context,requestPolicy:"network-only"})),Y=new Set,Z=(e={})=>{const t=!!e.staleWhileRevalidate,n=!!e.includeExtensions,r={},o=[],i=e=>{o.push(e.operation.key),1===o.length&&Promise.resolve().then((()=>{let e;for(;e=o.shift();)r[e]=null}))},a=({client:o,forward:a})=>c=>{const u=e&&"boolean"==typeof e.isClient?!!e.isClient:!o.suspense,l=b(c);let y=a(g((e=>!r[e.key]||!!r[e.key].hasNext))(l)),d=q((e=>{const i=((e,t,n)=>({operation:e,data:t.data?JSON.parse(t.data):void 0,extensions:n&&t.extensions?JSON.parse(t.extensions):void 0,error:t.error?new s({networkError:t.error.networkError?new Error(t.error.networkError):void 0,graphQLErrors:t.error.graphQLErrors}):void 0,hasNext:t.hasNext}))(e,r[e.key],n);return t&&!Y.has(e.key)&&(i.stale=!0,Y.add(e.key),X(o,e)),i}))(g((e=>!!r[e.key]&&"network-only"!==e.context.requestPolicy))(l));return u?d=O(i)(d):y=O((e=>{const{operation:t}=e;if("mutation"!==t.kind){const o=(({hasNext:e,data:t,extensions:n,error:r},o)=>{const s={};return void 0!==t&&(s.data=JSON.stringify(t)),o&&void 0!==n&&(s.extensions=JSON.stringify(n)),e&&(s.hasNext=!0),r&&(s.error={graphQLErrors:r.graphQLErrors.map((e=>e.path||e.extensions?{message:e.message,path:e.path,extensions:e.extensions}:e.message))},r.networkError&&(s.error.networkError=""+r.networkError)),s})(e,n);r[t.key]=o}}))(y),_([y,d])};return a.restoreData=e=>{for(const t in e)null!==r[t]&&(r[t]=e[t])},a.extractData=()=>{const e={};for(const t in r)null!=r[t]&&(e[t]=r[t]);return e},e&&e.initialState&&a.restoreData(e.initialState),a},ee=({forwardSubscription:e,enableAllOperations:t,isSubscriptionOperation:r})=>({client:o,forward:s})=>{const i=r||(e=>{const{kind:n}=e;return"subscription"===n||!!t&&("query"===n||"mutation"===n)});return t=>{const r=b(t),a=v((t=>{const{key:s}=t,i=g((e=>"teardown"===e.kind&&e.key===s))(r);return S(i)((t=>{const r=e({key:t.key.toString(36),query:n(t.query),variables:t.variables,context:{...t.context}});return E((({next:e,complete:n})=>{let s,i=!1;return Promise.resolve().then((()=>{i||(s=r.subscribe({next:n=>e(c(t,n)),error:n=>e(u(t,n)),complete:()=>{i||(i=!0,"subscription"===t.kind&&o.reexecuteOperation(V("teardown",t,t.context)),n())}}))})),()=>{i=!0,s&&s.unsubscribe()}}))})(t))}))(g(i)(r)),l=s(g((e=>!i(e)))(r));return _([a,l])}},te=({forward:e})=>t=>e(t),ne=({forward:e})=>{const t=new Set,n=e=>{const{key:n,kind:r}=e;if("teardown"===r||"mutation"===r)return t.delete(n),!0;const o=t.has(n);return t.add(n),!o},r=({operation:e,hasNext:n})=>{n||t.delete(e.key)};return t=>{const o=g(n)(t);return O(r)(e(o))}},re=({forward:e})=>t=>{const n=b(t),r=v((e=>{const{key:t}=e,r=l(e),o=y(e,r),s=d(e,r);return S(g((e=>"teardown"===e.kind&&e.key===t))(n))(p(e,o,s))}))(g((e=>"query"===e.kind||"mutation"===e.kind))(n)),o=e(g((e=>"query"!==e.kind&&"mutation"!==e.kind))(n));return _([r,o])},oe=({})=>e=>g((()=>!1))(O((e=>{}))(e)),se=oe({dispatchDebug:$}),ie=e=>({client:t,forward:n})=>e.reduceRight(((e,n)=>n({client:t,forward:e,dispatchDebug(e){}})),n),ae=({onError:e})=>({forward:t})=>n=>O((({error:t,operation:n})=>{t&&e(t,n)}))(t(n)),ce=[ne,K,re],ue=function e(t){const n=new Map,r=new Map,o=[],s={url:t.url,fetchOptions:t.fetchOptions,fetch:t.fetch,preferGetMethod:!!t.preferGetMethod,requestPolicy:t.requestPolicy||"cache-first"},{source:i,next:a}=N();let c=!1;function u(e){if(e&&a(e),!c){for(c=!0;c&&(e=o.shift());)a(e);c=!1}}const l=e=>{let s=g((t=>t.operation.kind===e.kind&&t.operation.key===e.key&&(!t.operation.context._instance||t.operation.context._instance===e.context._instance)))(m);return t.maskTypename&&(s=q((e=>({...e,data:G(e.data)})))(s)),"mutation"===e.kind?A(1)(M((()=>a(e)))(s)):b(R((()=>{n.delete(e.key),r.delete(e.key);for(let t=o.length-1;t>=0;t--)o[t].key===e.key&&o.splice(t,1);a(V("teardown",e,e.context))}))(P((t=>{n.set(e.key,t)}))(Q((t=>"query"!==e.kind||t.stale?F(t):_([F(t),q((()=>({...t,stale:!0})))(A(1)(g((t=>"query"===t.kind&&t.key===e.key&&"cache-only"!==t.context.requestPolicy))(i)))])))(S(g((t=>"teardown"===t.kind&&t.key===e.key))(i))(s)))))},y=this instanceof e?this:Object.create(e.prototype),d=Object.assign(y,{suspense:!!t.suspense,operations$:i,reexecuteOperation(e){("mutation"===e.kind||r.has(e.key))&&(o.push(e),Promise.resolve().then(u))},createRequestOperation:(e,t,n)=>(n||(n={}),k(t.query),V(e,t,{_instance:"mutation"===e?[]:void 0,...s,...n,suspense:n.suspense||!1!==n.suspense&&d.suspense})),executeRequestOperation:e=>"mutation"===e.kind?l(e):E((t=>{let o=r.get(e.key);o||r.set(e.key,o=l(e));const s="cache-and-network"===e.context.requestPolicy||"network-only"===e.context.requestPolicy;return w(t.next)(R((()=>{c=!1,t.complete()}))(M((()=>{const r=n.get(e.key);if("subscription"===e.kind)return u(e);s&&u(e),null!=r&&r===n.get(e.key)?t.next(s?{...r,stale:!0}:r):s||u(e)}))(o))).unsubscribe})),executeQuery(e,t){const n=d.createRequestOperation("query",e,t);return d.executeRequestOperation(n)},executeSubscription(e,t){const n=d.createRequestOperation("subscription",e,t);return d.executeRequestOperation(n)},executeMutation(e,t){const n=d.createRequestOperation("mutation",e,t);return d.executeRequestOperation(n)},query:(e,t,n)=>(n&&"boolean"==typeof n.suspense||(n={...n,suspense:!1}),U(d.executeQuery(x(e,t),n))),readQuery(e,t,n){let r=null;return w((e=>{r=e}))(d.query(e,t,n)).unsubscribe(),r},subscription:(e,t,n)=>d.executeSubscription(x(e,t),n),mutation:(e,t,n)=>U(d.executeMutation(x(e,t),n))});let p=$;const f=ie(void 0!==t.exchanges?t.exchanges:ce),m=b(f({client:d,dispatchDebug:p,forward:oe({dispatchDebug:p})})(i));return D(m),d},le=ue;export{ue as Client,K as cacheExchange,ie as composeExchanges,le as createClient,te as debugExchange,ne as dedupExchange,ce as defaultExchanges,ae as errorExchange,se as fallbackExchangeIO,re as fetchExchange,J as formatDocument,B as gql,V as makeOperation,G as maskTypename,Z as ssrExchange,ee as subscriptionExchange};
//# sourceMappingURL=urql-core.min.mjs.map
